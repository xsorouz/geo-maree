# =============================================================================
# nginx.conf ‚Äî Reverse Proxy p√©dagogique pour la stack SHOM
# =============================================================================
# üìç Objectif : Centraliser les acc√®s en HTTP via http://localhost
# =============================================================================
# Routage :
# - /            ‚Üí Page HTML statique (index.html dans /usr/share/nginx/html/)
# - /api/        ‚Üí Proxy vers FastAPI (microservice Python)
# - /geoserver/  ‚Üí Proxy vers GeoServer (WMS/WFS)
# - /minio/      ‚Üí Redirection vers MinIO Console (port 9003)
# - /grafana/    ‚Üí Redirection vers Grafana (port 3002)
# - /prometheus/ ‚Üí Redirection vers Prometheus (port 9091)
# =============================================================================

# Bloc obligatoire "events" (erreur que tu avais)
events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;

    server {
        listen 80;

        # ============================================
        # üè† Page d'accueil HTML
        # ============================================
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }

        # ============================================
        # üöÄ FastAPI
        # ============================================
        location /api/ {
            proxy_pass         http://shom-fastapi:8000/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
        }

        # ============================================
        # üó∫Ô∏è GeoServer
        # ============================================
        location /geoserver/ {
            proxy_pass http://shom-geoserver:8080/geoserver/;
            proxy_set_header Host $host;
        }

        # ============================================
        # üíæ MinIO
        # ============================================
        location /minio/ {
            return 302 http://localhost:9003/;
        }

        # ============================================
        # üìä Grafana
        # ============================================
        location /grafana/ {
            return 302 http://localhost:3002/;
        }

        # ============================================
        # üìà Prometheus
        # ============================================
        location /prometheus/ {
            return 302 http://localhost:9091/;
        }

        # ============================================
        # üì¶ Airbyte (si activ√©)
        # ============================================
        location /airbyte/ {
            return 302 http://localhost:8000/;
        }
    }
}
